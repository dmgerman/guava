begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2008 The Guava Authors  *  * Licensed under the Apache License, Version 2.0 (the "License");  * you may not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|com.google.common.util.concurrent
package|package
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Futures
operator|.
name|immediateFailedFuture
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Futures
operator|.
name|immediateFuture
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|MoreExecutors
operator|.
name|directExecutor
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|GwtCompatible
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Functions
import|;
end_import

begin_import
import|import
name|junit
operator|.
name|framework
operator|.
name|AssertionFailedError
import|;
end_import

begin_import
import|import
name|junit
operator|.
name|framework
operator|.
name|TestCase
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CancellationException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CountDownLatch
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executor
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Future
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_comment
comment|/**  * Unit tests for {@link Futures}.  *  * @author Nishant Thakkar  */
end_comment

begin_class
annotation|@
name|GwtCompatible
argument_list|(
name|emulated
operator|=
literal|true
argument_list|)
DECL|class|FuturesTest
specifier|public
class|class
name|FuturesTest
extends|extends
name|TestCase
block|{
DECL|field|DATA1
specifier|private
specifier|static
specifier|final
name|String
name|DATA1
init|=
literal|"data"
decl_stmt|;
DECL|field|DATA2
specifier|private
specifier|static
specifier|final
name|String
name|DATA2
init|=
literal|"more data"
decl_stmt|;
DECL|field|DATA3
specifier|private
specifier|static
specifier|final
name|String
name|DATA3
init|=
literal|"most data"
decl_stmt|;
DECL|method|testImmediateFuture ()
specifier|public
name|void
name|testImmediateFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|String
argument_list|>
name|future
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|DATA1
argument_list|)
decl_stmt|;
comment|// Verify that the proper object is returned without waiting
name|assertSame
argument_list|(
name|DATA1
argument_list|,
name|future
operator|.
name|get
argument_list|(
literal|0L
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testMultipleImmediateFutures ()
specifier|public
name|void
name|testMultipleImmediateFutures
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|DATA1
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|DATA2
argument_list|)
decl_stmt|;
comment|// Verify that the proper objects are returned without waiting
name|assertSame
argument_list|(
name|DATA1
argument_list|,
name|future1
operator|.
name|get
argument_list|(
literal|0L
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
argument_list|)
expr_stmt|;
name|assertSame
argument_list|(
name|DATA2
argument_list|,
name|future2
operator|.
name|get
argument_list|(
literal|0L
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|class|MyException
specifier|private
specifier|static
class|class
name|MyException
extends|extends
name|Exception
block|{    }
comment|// Class hierarchy for generics sanity checks
DECL|class|Foo
specifier|private
specifier|static
class|class
name|Foo
block|{    }
DECL|class|FooChild
specifier|private
specifier|static
class|class
name|FooChild
extends|extends
name|Foo
block|{    }
DECL|class|Bar
specifier|private
specifier|static
class|class
name|Bar
block|{    }
DECL|class|BarChild
specifier|private
specifier|static
class|class
name|BarChild
extends|extends
name|Bar
block|{    }
DECL|method|testTransform_genericsNull ()
specifier|public
name|void
name|testTransform_genericsNull
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|nullFuture
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|transformedFuture
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|nullFuture
argument_list|,
name|Functions
operator|.
name|constant
argument_list|(
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|assertNull
argument_list|(
name|transformedFuture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_genericsHierarchy ()
specifier|public
name|void
name|testTransform_genericsHierarchy
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|FooChild
argument_list|>
name|future
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
specifier|final
name|BarChild
name|barChild
init|=
operator|new
name|BarChild
argument_list|()
decl_stmt|;
name|Function
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
name|function
init|=
operator|new
name|Function
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|BarChild
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
return|return
name|barChild
return|;
block|}
block|}
decl_stmt|;
name|Bar
name|bar
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|future
argument_list|,
name|function
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertSame
argument_list|(
name|barChild
argument_list|,
name|bar
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_cancelPropagatesToInput ()
specifier|public
name|void
name|testTransform_cancelPropagatesToInput
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Foo
argument_list|>
name|input
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
throw|throw
operator|new
name|AssertionFailedError
argument_list|(
literal|"Unexpeted call to apply."
argument_list|)
throw|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transform
argument_list|(
name|input
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|input
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_interruptPropagatesToInput ()
specifier|public
name|void
name|testTransform_interruptPropagatesToInput
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Foo
argument_list|>
name|input
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
throw|throw
operator|new
name|AssertionFailedError
argument_list|(
literal|"Unexpeted call to apply."
argument_list|)
throw|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transform
argument_list|(
name|input
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_cancelPropagatesToAsyncOutput ()
specifier|public
name|void
name|testTransform_cancelPropagatesToAsyncOutput
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|immediate
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
operator|new
name|Foo
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Bar
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transform
argument_list|(
name|immediate
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|secondary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_interruptPropagatesToAsyncOutput ()
specifier|public
name|void
name|testTransform_interruptPropagatesToAsyncOutput
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|immediate
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
operator|new
name|Foo
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Bar
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transform
argument_list|(
name|immediate
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_cancelPropagatesToInput ()
specifier|public
name|void
name|testTransformAsync_cancelPropagatesToInput
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Foo
argument_list|>
name|input
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
throw|throw
operator|new
name|AssertionFailedError
argument_list|(
literal|"Unexpeted call to apply."
argument_list|)
throw|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transformAsync
argument_list|(
name|input
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|input
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_interruptPropagatesToInput ()
specifier|public
name|void
name|testTransformAsync_interruptPropagatesToInput
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Foo
argument_list|>
name|input
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
throw|throw
operator|new
name|AssertionFailedError
argument_list|(
literal|"Unexpeted call to apply."
argument_list|)
throw|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transformAsync
argument_list|(
name|input
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|input
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_cancelPropagatesToAsyncOutput ()
specifier|public
name|void
name|testTransformAsync_cancelPropagatesToAsyncOutput
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|immediate
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
operator|new
name|Foo
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Bar
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transformAsync
argument_list|(
name|immediate
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|secondary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_interruptPropagatesToAsyncOutput ()
specifier|public
name|void
name|testTransformAsync_interruptPropagatesToAsyncOutput
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|immediate
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
operator|new
name|Foo
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Bar
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|Bar
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Bar
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|assertTrue
argument_list|(
name|Futures
operator|.
name|transformAsync
argument_list|(
name|immediate
argument_list|,
name|function
argument_list|)
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|secondary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Tests that the function is invoked only once, even if it throws an exception.    */
DECL|method|testTransformValueRemainsMemoized ()
specifier|public
name|void
name|testTransformValueRemainsMemoized
parameter_list|()
throws|throws
name|Exception
block|{
class|class
name|Holder
block|{
name|int
name|value
init|=
literal|2
decl_stmt|;
block|}
specifier|final
name|Holder
name|holder
init|=
operator|new
name|Holder
argument_list|()
decl_stmt|;
comment|// This function adds the holder's value to the input value.
name|Function
argument_list|<
name|Integer
argument_list|,
name|Integer
argument_list|>
name|adder
init|=
operator|new
name|Function
argument_list|<
name|Integer
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Integer
name|apply
parameter_list|(
name|Integer
name|from
parameter_list|)
block|{
return|return
name|from
operator|+
name|holder
operator|.
name|value
return|;
block|}
block|}
decl_stmt|;
comment|// Since holder.value is 2, applying 4 should yield 6.
name|assertEquals
argument_list|(
literal|6
argument_list|,
name|adder
operator|.
name|apply
argument_list|(
literal|4
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|immediateFuture
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|4
argument_list|)
decl_stmt|;
name|Future
argument_list|<
name|Integer
argument_list|>
name|transformedFuture
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|immediateFuture
argument_list|,
name|adder
argument_list|)
decl_stmt|;
comment|// The composed future also yields 6.
name|assertEquals
argument_list|(
literal|6
argument_list|,
name|transformedFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Repeated calls yield the same value even though the function's behavior
comment|// changes
name|holder
operator|.
name|value
operator|=
literal|3
expr_stmt|;
name|assertEquals
argument_list|(
literal|6
argument_list|,
name|transformedFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|7
argument_list|,
name|adder
operator|.
name|apply
argument_list|(
literal|4
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Once more, with feeling.
name|holder
operator|.
name|value
operator|=
literal|4
expr_stmt|;
name|assertEquals
argument_list|(
literal|6
argument_list|,
name|transformedFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|8
argument_list|,
name|adder
operator|.
name|apply
argument_list|(
literal|4
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Memoized get also retains the value.
name|assertEquals
argument_list|(
literal|6
argument_list|,
name|transformedFuture
operator|.
name|get
argument_list|(
literal|1000
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Unsurprisingly, recomposing the future will return an updated value.
name|assertEquals
argument_list|(
literal|8
argument_list|,
name|Futures
operator|.
name|transform
argument_list|(
name|immediateFuture
argument_list|,
name|adder
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
comment|// Repeating, with the timeout version
name|assertEquals
argument_list|(
literal|8
argument_list|,
name|Futures
operator|.
name|transform
argument_list|(
name|immediateFuture
argument_list|,
name|adder
argument_list|)
operator|.
name|get
argument_list|(
literal|1000
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|class|MyError
specifier|static
class|class
name|MyError
extends|extends
name|Error
block|{    }
DECL|class|MyRuntimeException
specifier|static
class|class
name|MyRuntimeException
extends|extends
name|RuntimeException
block|{    }
comment|// TODO(cpovirk): top-level class?
DECL|class|ExecutorSpy
specifier|static
class|class
name|ExecutorSpy
implements|implements
name|Executor
block|{
DECL|field|delegate
name|Executor
name|delegate
decl_stmt|;
DECL|field|wasExecuted
name|boolean
name|wasExecuted
decl_stmt|;
DECL|method|ExecutorSpy (Executor delegate)
specifier|public
name|ExecutorSpy
parameter_list|(
name|Executor
name|delegate
parameter_list|)
block|{
name|this
operator|.
name|delegate
operator|=
name|delegate
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|execute (Runnable command)
specifier|public
name|void
name|execute
parameter_list|(
name|Runnable
name|command
parameter_list|)
block|{
name|delegate
operator|.
name|execute
argument_list|(
name|command
argument_list|)
expr_stmt|;
name|wasExecuted
operator|=
literal|true
expr_stmt|;
block|}
block|}
DECL|method|testTransform_Executor ()
specifier|public
name|void
name|testTransform_Executor
parameter_list|()
throws|throws
name|Exception
block|{
name|Object
name|value
init|=
operator|new
name|Object
argument_list|()
decl_stmt|;
name|ExecutorSpy
name|spy
init|=
operator|new
name|ExecutorSpy
argument_list|(
name|directExecutor
argument_list|()
argument_list|)
decl_stmt|;
name|assertFalse
argument_list|(
name|spy
operator|.
name|wasExecuted
argument_list|)
expr_stmt|;
name|ListenableFuture
argument_list|<
name|Object
argument_list|>
name|future
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|value
argument_list|)
argument_list|,
name|Functions
operator|.
name|identity
argument_list|()
argument_list|,
name|spy
argument_list|)
decl_stmt|;
name|assertSame
argument_list|(
name|value
argument_list|,
name|future
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|spy
operator|.
name|wasExecuted
argument_list|)
expr_stmt|;
block|}
DECL|class|FunctionSpy
specifier|private
specifier|static
class|class
name|FunctionSpy
parameter_list|<
name|I
parameter_list|,
name|O
parameter_list|>
implements|implements
name|Function
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
block|{
DECL|field|applyCount
specifier|private
name|int
name|applyCount
decl_stmt|;
DECL|field|delegate
specifier|private
specifier|final
name|Function
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
name|delegate
decl_stmt|;
DECL|method|FunctionSpy (Function<I, O> delegate)
specifier|public
name|FunctionSpy
parameter_list|(
name|Function
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
name|delegate
parameter_list|)
block|{
name|this
operator|.
name|delegate
operator|=
name|delegate
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|apply (I input)
specifier|public
name|O
name|apply
parameter_list|(
name|I
name|input
parameter_list|)
block|{
name|applyCount
operator|++
expr_stmt|;
return|return
name|delegate
operator|.
name|apply
argument_list|(
name|input
argument_list|)
return|;
block|}
DECL|method|verifyCallCount (int expected)
name|void
name|verifyCallCount
parameter_list|(
name|int
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|applyCount
argument_list|)
operator|.
name|is
argument_list|(
name|expected
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|spy (Function<I, O> delegate)
specifier|private
specifier|static
parameter_list|<
name|I
parameter_list|,
name|O
parameter_list|>
name|FunctionSpy
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
name|spy
parameter_list|(
name|Function
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
name|delegate
parameter_list|)
block|{
return|return
operator|new
name|FunctionSpy
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
argument_list|(
name|delegate
argument_list|)
return|;
block|}
DECL|method|unexpectedFunction ()
specifier|private
specifier|static
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|,
name|V
parameter_list|>
name|Function
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|unexpectedFunction
parameter_list|()
block|{
return|return
operator|new
name|Function
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|V
name|apply
parameter_list|(
name|X
name|t
parameter_list|)
block|{
throw|throw
name|newAssertionError
argument_list|(
literal|"Unexpected fallback"
argument_list|,
name|t
argument_list|)
throw|;
block|}
block|}
return|;
block|}
DECL|class|FutureFallbackSpy
specifier|private
specifier|static
class|class
name|FutureFallbackSpy
parameter_list|<
name|V
parameter_list|>
implements|implements
name|FutureFallback
argument_list|<
name|V
argument_list|>
block|{
DECL|field|count
specifier|private
name|int
name|count
decl_stmt|;
DECL|field|delegate
specifier|private
specifier|final
name|FutureFallback
argument_list|<
name|V
argument_list|>
name|delegate
decl_stmt|;
DECL|method|FutureFallbackSpy (FutureFallback<V> delegate)
specifier|public
name|FutureFallbackSpy
parameter_list|(
name|FutureFallback
argument_list|<
name|V
argument_list|>
name|delegate
parameter_list|)
block|{
name|this
operator|.
name|delegate
operator|=
name|delegate
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|create (Throwable t)
specifier|public
specifier|final
name|ListenableFuture
argument_list|<
name|V
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
name|count
operator|++
expr_stmt|;
return|return
name|delegate
operator|.
name|create
argument_list|(
name|t
argument_list|)
return|;
block|}
DECL|method|verifyCallCount (int expected)
name|void
name|verifyCallCount
parameter_list|(
name|int
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|count
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|spy (FutureFallback<V> delegate)
specifier|private
specifier|static
parameter_list|<
name|V
parameter_list|>
name|FutureFallbackSpy
argument_list|<
name|V
argument_list|>
name|spy
parameter_list|(
name|FutureFallback
argument_list|<
name|V
argument_list|>
name|delegate
parameter_list|)
block|{
return|return
operator|new
name|FutureFallbackSpy
argument_list|<
name|V
argument_list|>
argument_list|(
name|delegate
argument_list|)
return|;
block|}
DECL|method|unexpectedFallback ()
specifier|private
specifier|static
parameter_list|<
name|V
parameter_list|>
name|FutureFallback
argument_list|<
name|V
argument_list|>
name|unexpectedFallback
parameter_list|()
block|{
return|return
operator|new
name|FutureFallback
argument_list|<
name|V
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|V
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
throw|throw
name|newAssertionError
argument_list|(
literal|"Unexpected fallback"
argument_list|,
name|t
argument_list|)
throw|;
block|}
block|}
return|;
block|}
DECL|class|AsyncFunctionSpy
specifier|private
specifier|static
class|class
name|AsyncFunctionSpy
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|,
name|V
parameter_list|>
implements|implements
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
block|{
DECL|field|count
specifier|private
name|int
name|count
decl_stmt|;
DECL|field|delegate
specifier|private
specifier|final
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|delegate
decl_stmt|;
DECL|method|AsyncFunctionSpy (AsyncFunction<X, V> delegate)
specifier|public
name|AsyncFunctionSpy
parameter_list|(
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|delegate
parameter_list|)
block|{
name|this
operator|.
name|delegate
operator|=
name|delegate
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|apply (X t)
specifier|public
specifier|final
name|ListenableFuture
argument_list|<
name|V
argument_list|>
name|apply
parameter_list|(
name|X
name|t
parameter_list|)
throws|throws
name|Exception
block|{
name|count
operator|++
expr_stmt|;
return|return
name|delegate
operator|.
name|apply
argument_list|(
name|t
argument_list|)
return|;
block|}
DECL|method|verifyCallCount (int expected)
name|void
name|verifyCallCount
parameter_list|(
name|int
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|count
argument_list|)
operator|.
name|is
argument_list|(
name|expected
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|spy (AsyncFunction<X, V> delegate)
specifier|private
specifier|static
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|,
name|V
parameter_list|>
name|AsyncFunctionSpy
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|spy
parameter_list|(
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|delegate
parameter_list|)
block|{
return|return
operator|new
name|AsyncFunctionSpy
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
argument_list|(
name|delegate
argument_list|)
return|;
block|}
DECL|method|unexpectedAsyncFunction ()
specifier|private
specifier|static
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|,
name|V
parameter_list|>
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
name|unexpectedAsyncFunction
parameter_list|()
block|{
return|return
operator|new
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|V
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|V
argument_list|>
name|apply
parameter_list|(
name|X
name|t
parameter_list|)
block|{
throw|throw
name|newAssertionError
argument_list|(
literal|"Unexpected fallback"
argument_list|,
name|t
argument_list|)
throw|;
block|}
block|}
return|;
block|}
comment|/** Alternative to AssertionError(String, Throwable), which doesn't exist in GWT 2.6.1. */
DECL|method|newAssertionError (String message, Throwable cause)
specifier|private
specifier|static
name|AssertionError
name|newAssertionError
parameter_list|(
name|String
name|message
parameter_list|,
name|Throwable
name|cause
parameter_list|)
block|{
name|AssertionError
name|e
init|=
operator|new
name|AssertionError
argument_list|(
name|message
argument_list|)
decl_stmt|;
name|e
operator|.
name|initCause
argument_list|(
name|cause
argument_list|)
expr_stmt|;
return|return
name|e
return|;
block|}
DECL|method|testWithFallback_inputDoesNotRaiseException ()
specifier|public
name|void
name|testWithFallback_inputDoesNotRaiseException
parameter_list|()
throws|throws
name|Exception
block|{
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFallback
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|originalFuture
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|7
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|originalFuture
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|7
argument_list|,
name|faultToleranteFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_inputRaisesException ()
specifier|public
name|void
name|testWithFallback_inputRaisesException
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|RuntimeException
name|raisedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|FutureFallbackSpy
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
name|assertThat
argument_list|(
name|t
argument_list|)
operator|.
name|isSameAs
argument_list|(
name|raisedException
argument_list|)
expr_stmt|;
return|return
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|20
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
name|raisedException
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultTolerantFuture
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|failingFuture
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|20
argument_list|,
name|faultTolerantFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_fallbackGeneratesRuntimeException ()
specifier|public
name|void
name|testWithFallback_fallbackGeneratesRuntimeException
parameter_list|()
throws|throws
name|Exception
block|{
name|RuntimeException
name|expectedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|runExpectedExceptionFallbackTest
argument_list|(
name|expectedException
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_fallbackGeneratesCheckedException ()
specifier|public
name|void
name|testWithFallback_fallbackGeneratesCheckedException
parameter_list|()
throws|throws
name|Exception
block|{
name|Exception
name|expectedException
init|=
operator|new
name|Exception
argument_list|()
block|{     }
decl_stmt|;
name|runExpectedExceptionFallbackTest
argument_list|(
name|expectedException
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_fallbackGeneratesError ()
specifier|public
name|void
name|testWithFallback_fallbackGeneratesError
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Error
name|error
init|=
operator|new
name|Error
argument_list|(
literal|"deliberate"
argument_list|)
decl_stmt|;
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
operator|new
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
throw|throw
name|error
throw|;
block|}
block|}
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|Futures
operator|.
name|withFallback
argument_list|(
name|failingFuture
argument_list|,
name|fallback
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|assertSame
argument_list|(
name|error
argument_list|,
name|expected
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testWithFallback_fallbackReturnsRuntimeException ()
specifier|public
name|void
name|testWithFallback_fallbackReturnsRuntimeException
parameter_list|()
throws|throws
name|Exception
block|{
name|RuntimeException
name|expectedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|runExpectedExceptionFallbackTest
argument_list|(
name|expectedException
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_fallbackReturnsCheckedException ()
specifier|public
name|void
name|testWithFallback_fallbackReturnsCheckedException
parameter_list|()
throws|throws
name|Exception
block|{
name|Exception
name|expectedException
init|=
operator|new
name|Exception
argument_list|()
block|{     }
decl_stmt|;
name|runExpectedExceptionFallbackTest
argument_list|(
name|expectedException
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|method|runExpectedExceptionFallbackTest ( final Exception expectedException, final boolean wrapInFuture)
specifier|private
name|void
name|runExpectedExceptionFallbackTest
parameter_list|(
specifier|final
name|Exception
name|expectedException
parameter_list|,
specifier|final
name|boolean
name|wrapInFuture
parameter_list|)
throws|throws
name|Exception
block|{
name|FutureFallbackSpy
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|wrapInFuture
condition|)
block|{
throw|throw
name|expectedException
throw|;
block|}
else|else
block|{
return|return
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
name|expectedException
argument_list|)
return|;
block|}
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|failingFuture
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
try|try
block|{
name|faultToleranteFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|ee
parameter_list|)
block|{
name|assertSame
argument_list|(
name|expectedException
argument_list|,
name|ee
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_fallbackNotReady ()
specifier|public
name|void
name|testWithFallback_fallbackNotReady
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|Exception
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
operator|new
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|primary
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|secondary
operator|.
name|set
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
operator|(
name|int
operator|)
name|derived
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_resultInterruptedBeforeFallback ()
specifier|public
name|void
name|testWithFallback_resultInterruptedBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFallback
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|primary
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_resultCancelledBeforeFallback ()
specifier|public
name|void
name|testWithFallback_resultCancelledBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFallback
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|primary
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testWithFallback_nullInsteadOfFuture ()
specifier|public
name|void
name|testWithFallback_nullInsteadOfFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|inputFuture
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|Exception
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|withFallback
argument_list|(
name|inputFuture
argument_list|,
operator|new
name|FutureFallback
argument_list|<
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|create
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
return|return
literal|null
return|;
block|}
block|}
argument_list|)
decl_stmt|;
try|try
block|{
name|chainedFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|NullPointerException
name|cause
init|=
operator|(
name|NullPointerException
operator|)
name|expected
operator|.
name|getCause
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|cause
argument_list|)
operator|.
name|hasMessage
argument_list|(
literal|"FutureFallback.create returned null instead of a Future. "
operator|+
literal|"Did you mean to return immediateFuture(null)?"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// catchingAsync tests cloned from the old withFallback tests:
DECL|method|testCatchingAsync_inputDoesNotRaiseException ()
specifier|public
name|void
name|testCatchingAsync_inputDoesNotRaiseException
parameter_list|()
throws|throws
name|Exception
block|{
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedAsyncFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|originalFuture
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|7
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|originalFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|7
argument_list|,
name|faultToleranteFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_inputRaisesException ()
specifier|public
name|void
name|testCatchingAsync_inputRaisesException
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|RuntimeException
name|raisedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|AsyncFunctionSpy
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
name|assertThat
argument_list|(
name|t
argument_list|)
operator|.
name|isSameAs
argument_list|(
name|raisedException
argument_list|)
expr_stmt|;
return|return
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|20
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
name|raisedException
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultTolerantFuture
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|20
argument_list|,
name|faultTolerantFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_fallbackGeneratesRuntimeException ()
specifier|public
name|void
name|testCatchingAsync_fallbackGeneratesRuntimeException
parameter_list|()
throws|throws
name|Exception
block|{
name|RuntimeException
name|expectedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|runExpectedExceptionCatchingAsyncTest
argument_list|(
name|expectedException
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_fallbackGeneratesCheckedException ()
specifier|public
name|void
name|testCatchingAsync_fallbackGeneratesCheckedException
parameter_list|()
throws|throws
name|Exception
block|{
name|Exception
name|expectedException
init|=
operator|new
name|Exception
argument_list|()
block|{     }
decl_stmt|;
name|runExpectedExceptionCatchingAsyncTest
argument_list|(
name|expectedException
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_fallbackGeneratesError ()
specifier|public
name|void
name|testCatchingAsync_fallbackGeneratesError
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Error
name|error
init|=
operator|new
name|Error
argument_list|(
literal|"deliberate"
argument_list|)
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
throw|throw
name|error
throw|;
block|}
block|}
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|assertSame
argument_list|(
name|error
argument_list|,
name|expected
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testCatchingAsync_fallbackReturnsRuntimeException ()
specifier|public
name|void
name|testCatchingAsync_fallbackReturnsRuntimeException
parameter_list|()
throws|throws
name|Exception
block|{
name|RuntimeException
name|expectedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|runExpectedExceptionCatchingAsyncTest
argument_list|(
name|expectedException
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_fallbackReturnsCheckedException ()
specifier|public
name|void
name|testCatchingAsync_fallbackReturnsCheckedException
parameter_list|()
throws|throws
name|Exception
block|{
name|Exception
name|expectedException
init|=
operator|new
name|Exception
argument_list|()
block|{     }
decl_stmt|;
name|runExpectedExceptionCatchingAsyncTest
argument_list|(
name|expectedException
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|method|runExpectedExceptionCatchingAsyncTest ( final Exception expectedException, final boolean wrapInFuture)
specifier|private
name|void
name|runExpectedExceptionCatchingAsyncTest
parameter_list|(
specifier|final
name|Exception
name|expectedException
parameter_list|,
specifier|final
name|boolean
name|wrapInFuture
parameter_list|)
throws|throws
name|Exception
block|{
name|AsyncFunctionSpy
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
operator|!
name|wrapInFuture
condition|)
block|{
throw|throw
name|expectedException
throw|;
block|}
else|else
block|{
return|return
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
name|expectedException
argument_list|)
return|;
block|}
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
try|try
block|{
name|faultToleranteFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|ee
parameter_list|)
block|{
name|assertSame
argument_list|(
name|expectedException
argument_list|,
name|ee
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_fallbackNotReady ()
specifier|public
name|void
name|testCatchingAsync_fallbackNotReady
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|Exception
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|secondary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
return|return
name|secondary
return|;
block|}
block|}
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|primary
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|secondary
operator|.
name|set
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
operator|(
name|int
operator|)
name|derived
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_resultInterruptedBeforeFallback ()
specifier|public
name|void
name|testCatchingAsync_resultInterruptedBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedAsyncFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|primary
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_resultCancelledBeforeFallback ()
specifier|public
name|void
name|testCatchingAsync_resultCancelledBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedAsyncFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|primary
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_nullInsteadOfFuture ()
specifier|public
name|void
name|testCatchingAsync_nullInsteadOfFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|inputFuture
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|Exception
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|inputFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
operator|new
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
return|return
literal|null
return|;
block|}
block|}
argument_list|)
decl_stmt|;
try|try
block|{
name|chainedFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|NullPointerException
name|cause
init|=
operator|(
name|NullPointerException
operator|)
name|expected
operator|.
name|getCause
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|cause
argument_list|)
operator|.
name|hasMessage
argument_list|(
literal|"AsyncFunction.apply returned null instead of a Future. "
operator|+
literal|"Did you mean to return immediateFuture(null)?"
argument_list|)
expr_stmt|;
block|}
block|}
comment|// catching tests cloned from the old withFallback tests:
DECL|method|testCatching_inputDoesNotRaiseException ()
specifier|public
name|void
name|testCatching_inputDoesNotRaiseException
parameter_list|()
throws|throws
name|Exception
block|{
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|originalFuture
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|7
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|originalFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|7
argument_list|,
name|faultToleranteFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatching_inputRaisesException ()
specifier|public
name|void
name|testCatching_inputRaisesException
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|RuntimeException
name|raisedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|FunctionSpy
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Integer
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|assertThat
argument_list|(
name|t
argument_list|)
operator|.
name|isSameAs
argument_list|(
name|raisedException
argument_list|)
expr_stmt|;
return|return
literal|20
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
name|raisedException
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultTolerantFuture
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|20
argument_list|,
name|faultTolerantFuture
operator|.
name|get
argument_list|()
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatching_fallbackGeneratesRuntimeException ()
specifier|public
name|void
name|testCatching_fallbackGeneratesRuntimeException
parameter_list|()
throws|throws
name|Exception
block|{
name|RuntimeException
name|expectedException
init|=
operator|new
name|RuntimeException
argument_list|()
decl_stmt|;
name|runExpectedExceptionCatchingTest
argument_list|(
name|expectedException
argument_list|)
expr_stmt|;
block|}
comment|/*    * catching() uses a plain Function, so there's no    * testCatching_fallbackGeneratesCheckedException().    */
DECL|method|testCatching_fallbackGeneratesError ()
specifier|public
name|void
name|testCatching_fallbackGeneratesError
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Error
name|error
init|=
operator|new
name|Error
argument_list|(
literal|"deliberate"
argument_list|)
decl_stmt|;
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
operator|new
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Integer
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
throw|throw
name|error
throw|;
block|}
block|}
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|Futures
operator|.
name|catching
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|assertSame
argument_list|(
name|error
argument_list|,
name|expected
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * catching() uses a plain Function, so there's no testCatching_fallbackReturnsRuntimeException()    * or testCatching_fallbackReturnsCheckedException().    */
DECL|method|runExpectedExceptionCatchingTest (final RuntimeException expectedException)
specifier|private
name|void
name|runExpectedExceptionCatchingTest
parameter_list|(
specifier|final
name|RuntimeException
name|expectedException
parameter_list|)
throws|throws
name|Exception
block|{
name|FunctionSpy
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|spy
argument_list|(
operator|new
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Integer
name|apply
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
throw|throw
name|expectedException
throw|;
block|}
block|}
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|failingFuture
init|=
name|Futures
operator|.
name|immediateFailedFuture
argument_list|(
operator|new
name|RuntimeException
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultToleranteFuture
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|failingFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
try|try
block|{
name|faultToleranteFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"An Exception should have been thrown!"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|ee
parameter_list|)
block|{
name|assertSame
argument_list|(
name|expectedException
argument_list|,
name|ee
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|fallback
operator|.
name|verifyCallCount
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// catching() uses a plain Function, so there's no testCatching_fallbackNotReady().
DECL|method|testCatching_resultInterruptedBeforeFallback ()
specifier|public
name|void
name|testCatching_resultInterruptedBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|primary
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatching_resultCancelledBeforeFallback ()
specifier|public
name|void
name|testCatching_resultCancelledBeforeFallback
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|Integer
argument_list|>
name|primary
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|unexpectedFunction
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|derived
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|primary
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|derived
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primary
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|primary
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// catching() uses a plain Function, so there's no testCatching_resultCancelledAfterFallback().
comment|// catching() uses a plain Function, so there's no testCatching_nullInsteadOfFuture().
comment|// Some tests of the exceptionType parameter:
DECL|method|testCatching_Throwable ()
specifier|public
name|void
name|testCatching_Throwable
parameter_list|()
throws|throws
name|Exception
block|{
name|Function
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|functionReturningOne
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|originalFuture
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|IOException
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultTolerantFuture
init|=
name|Futures
operator|.
name|catching
argument_list|(
name|originalFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
operator|(
name|int
operator|)
name|faultTolerantFuture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testCatchingAsync_Throwable ()
specifier|public
name|void
name|testCatchingAsync_Throwable
parameter_list|()
throws|throws
name|Exception
block|{
name|AsyncFunction
argument_list|<
name|Throwable
argument_list|,
name|Integer
argument_list|>
name|fallback
init|=
name|asyncFunctionReturningOne
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|originalFuture
init|=
name|immediateFailedFuture
argument_list|(
operator|new
name|IOException
argument_list|()
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|faultTolerantFuture
init|=
name|Futures
operator|.
name|catchingAsync
argument_list|(
name|originalFuture
argument_list|,
name|Throwable
operator|.
name|class
argument_list|,
name|fallback
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
operator|(
name|int
operator|)
name|faultTolerantFuture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|functionReturningOne ()
specifier|private
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|>
name|Function
argument_list|<
name|X
argument_list|,
name|Integer
argument_list|>
name|functionReturningOne
parameter_list|()
block|{
return|return
operator|new
name|Function
argument_list|<
name|X
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Integer
name|apply
parameter_list|(
name|X
name|t
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
block|}
return|;
block|}
DECL|method|asyncFunctionReturningOne ()
specifier|private
parameter_list|<
name|X
extends|extends
name|Throwable
parameter_list|>
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|Integer
argument_list|>
name|asyncFunctionReturningOne
parameter_list|()
block|{
return|return
operator|new
name|AsyncFunction
argument_list|<
name|X
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|X
name|t
parameter_list|)
block|{
return|return
name|immediateFuture
argument_list|(
literal|1
argument_list|)
return|;
block|}
block|}
return|;
block|}
DECL|method|constantAsyncFunction ( final ListenableFuture<O> output)
specifier|private
specifier|static
parameter_list|<
name|I
parameter_list|,
name|O
parameter_list|>
name|AsyncFunction
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
name|constantAsyncFunction
parameter_list|(
specifier|final
name|ListenableFuture
argument_list|<
name|O
argument_list|>
name|output
parameter_list|)
block|{
return|return
operator|new
name|AsyncFunction
argument_list|<
name|I
argument_list|,
name|O
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|O
argument_list|>
name|apply
parameter_list|(
name|I
name|input
parameter_list|)
block|{
return|return
name|output
return|;
block|}
block|}
return|;
block|}
DECL|method|testTransform_genericsWildcard_AsyncFunction ()
specifier|public
name|void
name|testTransform_genericsWildcard_AsyncFunction
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|nullFuture
init|=
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|nullFuture
argument_list|,
name|constantAsyncFunction
argument_list|(
name|nullFuture
argument_list|)
argument_list|)
decl_stmt|;
name|assertNull
argument_list|(
name|chainedFuture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_genericsHierarchy_AsyncFunction ()
specifier|public
name|void
name|testTransform_genericsHierarchy_AsyncFunction
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|FooChild
argument_list|>
name|future
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
specifier|final
name|BarChild
name|barChild
init|=
operator|new
name|BarChild
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
name|future
init|=
operator|new
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
argument_list|()
block|{             }
decl_stmt|;
name|future
operator|.
name|set
argument_list|(
name|barChild
argument_list|)
expr_stmt|;
return|return
name|future
return|;
block|}
block|}
decl_stmt|;
name|Bar
name|bar
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|future
argument_list|,
name|function
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertSame
argument_list|(
name|barChild
argument_list|,
name|bar
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransform_asyncFunction_error ()
specifier|public
name|void
name|testTransform_asyncFunction_error
parameter_list|()
throws|throws
name|InterruptedException
block|{
specifier|final
name|Error
name|error
init|=
operator|new
name|Error
argument_list|(
literal|"deliberate"
argument_list|)
decl_stmt|;
name|AsyncFunction
argument_list|<
name|String
argument_list|,
name|Integer
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|String
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|String
name|input
parameter_list|)
block|{
throw|throw
name|error
throw|;
block|}
block|}
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|inputFuture
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|outputFuture
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|inputFuture
argument_list|,
name|function
argument_list|)
decl_stmt|;
name|inputFuture
operator|.
name|set
argument_list|(
literal|"value"
argument_list|)
expr_stmt|;
try|try
block|{
name|outputFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown error"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
name|assertSame
argument_list|(
name|error
argument_list|,
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testTransform_asyncFunction_nullInsteadOfFuture ()
specifier|public
name|void
name|testTransform_asyncFunction_nullInsteadOfFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|inputFuture
init|=
name|immediateFuture
argument_list|(
literal|"a"
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|transform
argument_list|(
name|inputFuture
argument_list|,
name|constantAsyncFunction
argument_list|(
literal|null
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|chainedFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|NullPointerException
name|cause
init|=
operator|(
name|NullPointerException
operator|)
name|expected
operator|.
name|getCause
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|cause
argument_list|)
operator|.
name|hasMessage
argument_list|(
literal|"AsyncFunction.apply returned null instead of a Future. "
operator|+
literal|"Did you mean to return immediateFuture(null)?"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testTransformAsync_genericsWildcard_AsyncFunction ()
specifier|public
name|void
name|testTransformAsync_genericsWildcard_AsyncFunction
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|nullFuture
init|=
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|transformAsync
argument_list|(
name|nullFuture
argument_list|,
name|constantAsyncFunction
argument_list|(
name|nullFuture
argument_list|)
argument_list|)
decl_stmt|;
name|assertNull
argument_list|(
name|chainedFuture
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_genericsHierarchy_AsyncFunction ()
specifier|public
name|void
name|testTransformAsync_genericsHierarchy_AsyncFunction
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|FooChild
argument_list|>
name|future
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
specifier|final
name|BarChild
name|barChild
init|=
operator|new
name|BarChild
argument_list|()
decl_stmt|;
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|Foo
argument_list|,
name|BarChild
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
name|apply
parameter_list|(
name|Foo
name|unused
parameter_list|)
block|{
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
name|future
init|=
operator|new
name|AbstractFuture
argument_list|<
name|BarChild
argument_list|>
argument_list|()
block|{             }
decl_stmt|;
name|future
operator|.
name|set
argument_list|(
name|barChild
argument_list|)
expr_stmt|;
return|return
name|future
return|;
block|}
block|}
decl_stmt|;
name|Bar
name|bar
init|=
name|Futures
operator|.
name|transformAsync
argument_list|(
name|future
argument_list|,
name|function
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertSame
argument_list|(
name|barChild
argument_list|,
name|bar
argument_list|)
expr_stmt|;
block|}
DECL|method|testTransformAsync_asyncFunction_error ()
specifier|public
name|void
name|testTransformAsync_asyncFunction_error
parameter_list|()
throws|throws
name|InterruptedException
block|{
specifier|final
name|Error
name|error
init|=
operator|new
name|Error
argument_list|(
literal|"deliberate"
argument_list|)
decl_stmt|;
name|AsyncFunction
argument_list|<
name|String
argument_list|,
name|Integer
argument_list|>
name|function
init|=
operator|new
name|AsyncFunction
argument_list|<
name|String
argument_list|,
name|Integer
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|apply
parameter_list|(
name|String
name|input
parameter_list|)
block|{
throw|throw
name|error
throw|;
block|}
block|}
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|inputFuture
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Integer
argument_list|>
name|outputFuture
init|=
name|Futures
operator|.
name|transformAsync
argument_list|(
name|inputFuture
argument_list|,
name|function
argument_list|)
decl_stmt|;
name|inputFuture
operator|.
name|set
argument_list|(
literal|"value"
argument_list|)
expr_stmt|;
try|try
block|{
name|outputFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"should have thrown error"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
name|assertSame
argument_list|(
name|error
argument_list|,
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testTransformAsync_asyncFunction_nullInsteadOfFuture ()
specifier|public
name|void
name|testTransformAsync_asyncFunction_nullInsteadOfFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|inputFuture
init|=
name|immediateFuture
argument_list|(
literal|"a"
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|chainedFuture
init|=
name|Futures
operator|.
name|transformAsync
argument_list|(
name|inputFuture
argument_list|,
name|constantAsyncFunction
argument_list|(
literal|null
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|chainedFuture
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|expected
parameter_list|)
block|{
name|NullPointerException
name|cause
init|=
operator|(
name|NullPointerException
operator|)
name|expected
operator|.
name|getCause
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|cause
argument_list|)
operator|.
name|hasMessage
argument_list|(
literal|"AsyncFunction.apply returned null instead of a Future. "
operator|+
literal|"Did you mean to return immediateFuture(null)?"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testDereference_genericsWildcard ()
specifier|public
name|void
name|testDereference_genericsWildcard
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|inner
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|?
argument_list|>
argument_list|>
name|outer
init|=
name|Futures
operator|.
expr|<
name|ListenableFuture
argument_list|<
name|?
argument_list|>
operator|>
name|immediateFuture
argument_list|(
name|inner
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|?
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|assertNull
argument_list|(
name|dereferenced
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testDereference_genericsHierarchy ()
specifier|public
name|void
name|testDereference_genericsHierarchy
parameter_list|()
throws|throws
name|Exception
block|{
name|FooChild
name|fooChild
init|=
operator|new
name|FooChild
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|FooChild
argument_list|>
name|inner
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|fooChild
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|FooChild
argument_list|>
argument_list|>
name|outer
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|inner
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
expr|<
name|Foo
operator|>
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|assertSame
argument_list|(
name|fooChild
argument_list|,
name|dereferenced
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testDereference_resultCancelsOuter ()
specifier|public
name|void
name|testDereference_resultCancelsOuter
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
argument_list|>
name|outer
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|dereferenced
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|outer
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testDereference_resultCancelsInner ()
specifier|public
name|void
name|testDereference_resultCancelsInner
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|inner
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
argument_list|>
name|outer
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|inner
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|dereferenced
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|inner
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testDereference_outerCancelsResult ()
specifier|public
name|void
name|testDereference_outerCancelsResult
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
argument_list|>
name|outer
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|outer
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dereferenced
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testDereference_innerCancelsResult ()
specifier|public
name|void
name|testDereference_innerCancelsResult
parameter_list|()
throws|throws
name|Exception
block|{
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|inner
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
argument_list|>
name|outer
init|=
name|Futures
operator|.
name|immediateFuture
argument_list|(
name|inner
argument_list|)
decl_stmt|;
name|ListenableFuture
argument_list|<
name|Foo
argument_list|>
name|dereferenced
init|=
name|Futures
operator|.
name|dereference
argument_list|(
name|outer
argument_list|)
decl_stmt|;
name|inner
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|dereferenced
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Runnable which can be called a single time, and only after {@link #expectCall} is called.    */
comment|// TODO(cpovirk): top-level class?
DECL|class|SingleCallListener
specifier|static
class|class
name|SingleCallListener
implements|implements
name|Runnable
block|{
DECL|field|expectCall
specifier|private
name|boolean
name|expectCall
init|=
literal|false
decl_stmt|;
DECL|field|calledCountDown
specifier|private
specifier|final
name|CountDownLatch
name|calledCountDown
init|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
decl_stmt|;
annotation|@
name|Override
DECL|method|run ()
specifier|public
name|void
name|run
parameter_list|()
block|{
name|assertTrue
argument_list|(
literal|"Listener called before it was expected"
argument_list|,
name|expectCall
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
literal|"Listener called more than once"
argument_list|,
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
name|calledCountDown
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
DECL|method|expectCall ()
specifier|public
name|void
name|expectCall
parameter_list|()
block|{
name|assertFalse
argument_list|(
literal|"expectCall is already true"
argument_list|,
name|expectCall
argument_list|)
expr_stmt|;
name|expectCall
operator|=
literal|true
expr_stmt|;
block|}
DECL|method|wasCalled ()
specifier|public
name|boolean
name|wasCalled
parameter_list|()
block|{
return|return
name|calledCountDown
operator|.
name|getCount
argument_list|()
operator|==
literal|0
return|;
block|}
DECL|method|waitForCall ()
specifier|public
name|void
name|waitForCall
parameter_list|()
throws|throws
name|InterruptedException
block|{
name|assertTrue
argument_list|(
literal|"expectCall is false"
argument_list|,
name|expectCall
argument_list|)
expr_stmt|;
name|calledCountDown
operator|.
name|await
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|testAllAsList ()
specifier|public
name|void
name|testAllAsList
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Create input and output
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future3
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|,
name|future3
argument_list|)
decl_stmt|;
comment|// Attach a listener
name|SingleCallListener
name|listener
init|=
operator|new
name|SingleCallListener
argument_list|()
decl_stmt|;
name|compound
operator|.
name|addListener
argument_list|(
name|listener
argument_list|,
name|directExecutor
argument_list|()
argument_list|)
expr_stmt|;
comment|// Satisfy each input and check the output
name|assertFalse
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|future1
operator|.
name|set
argument_list|(
name|DATA1
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|future2
operator|.
name|set
argument_list|(
name|DATA2
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|listener
operator|.
name|expectCall
argument_list|()
expr_stmt|;
name|future3
operator|.
name|set
argument_list|(
name|DATA3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listener
operator|.
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|results
init|=
name|compound
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|DATA1
argument_list|,
name|DATA2
argument_list|,
name|DATA3
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
DECL|method|testAllAsList_emptyArray ()
specifier|public
name|void
name|testAllAsList_emptyArray
parameter_list|()
throws|throws
name|Exception
block|{
name|SingleCallListener
name|listener
init|=
operator|new
name|SingleCallListener
argument_list|()
decl_stmt|;
name|listener
operator|.
name|expectCall
argument_list|()
expr_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|()
decl_stmt|;
name|compound
operator|.
name|addListener
argument_list|(
name|listener
argument_list|,
name|directExecutor
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|get
argument_list|()
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listener
operator|.
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testAllAsList_failure ()
specifier|public
name|void
name|testAllAsList_failure
parameter_list|()
throws|throws
name|Exception
block|{
name|SingleCallListener
name|listener
init|=
operator|new
name|SingleCallListener
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
name|compound
operator|.
name|addListener
argument_list|(
name|listener
argument_list|,
name|directExecutor
argument_list|()
argument_list|)
expr_stmt|;
name|listener
operator|.
name|expectCall
argument_list|()
expr_stmt|;
name|Throwable
name|exception
init|=
operator|new
name|Throwable
argument_list|(
literal|"failed1"
argument_list|)
decl_stmt|;
name|future1
operator|.
name|setException
argument_list|(
name|exception
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listener
operator|.
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
name|future2
operator|.
name|set
argument_list|(
literal|"result2"
argument_list|)
expr_stmt|;
try|try
block|{
name|compound
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected exception not thrown"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
name|assertSame
argument_list|(
name|exception
argument_list|,
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testAllAsList_cancelled ()
specifier|public
name|void
name|testAllAsList_cancelled
parameter_list|()
throws|throws
name|Exception
block|{
name|SingleCallListener
name|listener
init|=
operator|new
name|SingleCallListener
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
name|compound
operator|.
name|addListener
argument_list|(
name|listener
argument_list|,
name|directExecutor
argument_list|()
argument_list|)
expr_stmt|;
name|listener
operator|.
name|expectCall
argument_list|()
expr_stmt|;
name|future1
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listener
operator|.
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
name|future2
operator|.
name|setException
argument_list|(
operator|new
name|Throwable
argument_list|(
literal|"failed2"
argument_list|)
argument_list|)
expr_stmt|;
try|try
block|{
name|compound
operator|.
name|get
argument_list|()
expr_stmt|;
name|fail
argument_list|(
literal|"Expected exception not thrown"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|CancellationException
name|e
parameter_list|)
block|{
comment|// Expected
block|}
block|}
DECL|method|testAllAsList_resultCancelled ()
specifier|public
name|void
name|testAllAsList_resultCancelled
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
name|future2
operator|.
name|set
argument_list|(
name|DATA2
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|future1
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testAllAsList_resultCancelledInterrupted_withSecondaryListFuture ()
specifier|public
name|void
name|testAllAsList_resultCancelledInterrupted_withSecondaryListFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
comment|// There was a bug where the event listener for the combined future would
comment|// result in the sub-futures being cancelled without being interrupted.
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|otherCompound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future2
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future2
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|otherCompound
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testAllAsList_resultCancelled_withSecondaryListFuture ()
specifier|public
name|void
name|testAllAsList_resultCancelled_withSecondaryListFuture
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
comment|// This next call is "unused," but it is an important part of the test. Don't remove it!
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|cancel
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|future1
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future2
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|future2
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|testAllAsList_resultInterrupted ()
specifier|public
name|void
name|testAllAsList_resultInterrupted
parameter_list|()
throws|throws
name|Exception
block|{
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|)
decl_stmt|;
name|future2
operator|.
name|set
argument_list|(
name|DATA2
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|cancel
argument_list|(
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|isCancelled
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|future1
operator|.
name|wasInterrupted
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Test the case where the futures are fulfilled prior to constructing the ListFuture.  There was    * a bug where the loop that connects a Listener to each of the futures would die on the last    * loop-check as done() on ListFuture nulled out the variable being looped over (the list of    * futures).    */
DECL|method|testAllAsList_doneFutures ()
specifier|public
name|void
name|testAllAsList_doneFutures
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Create input and output
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future1
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future2
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
name|SettableFuture
argument_list|<
name|String
argument_list|>
name|future3
init|=
name|SettableFuture
operator|.
name|create
argument_list|()
decl_stmt|;
comment|// Satisfy each input prior to creating compound and check the output
name|future1
operator|.
name|set
argument_list|(
name|DATA1
argument_list|)
expr_stmt|;
name|future2
operator|.
name|set
argument_list|(
name|DATA2
argument_list|)
expr_stmt|;
name|future3
operator|.
name|set
argument_list|(
name|DATA3
argument_list|)
expr_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
comment|// array is never modified
name|ListenableFuture
argument_list|<
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|compound
init|=
name|Futures
operator|.
name|allAsList
argument_list|(
name|future1
argument_list|,
name|future2
argument_list|,
name|future3
argument_list|)
decl_stmt|;
comment|// Attach a listener
name|SingleCallListener
name|listener
init|=
operator|new
name|SingleCallListener
argument_list|()
decl_stmt|;
name|listener
operator|.
name|expectCall
argument_list|()
expr_stmt|;
name|compound
operator|.
name|addListener
argument_list|(
name|listener
argument_list|,
name|directExecutor
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|compound
operator|.
name|isDone
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|listener
operator|.
name|wasCalled
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|results
init|=
name|compound
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|DATA1
argument_list|,
name|DATA2
argument_list|,
name|DATA3
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
DECL|method|createCombinedResult (Integer i, Boolean b)
specifier|private
specifier|static
name|String
name|createCombinedResult
parameter_list|(
name|Integer
name|i
parameter_list|,
name|Boolean
name|b
parameter_list|)
block|{
return|return
literal|"-"
operator|+
name|i
operator|+
literal|"-"
operator|+
name|b
return|;
block|}
comment|/*    * TODO(cpovirk): maybe pass around TestFuture instances instead of    * ListenableFuture instances    */
DECL|class|OtherThrowable
specifier|private
specifier|static
specifier|final
class|class
name|OtherThrowable
extends|extends
name|Throwable
block|{    }
comment|// Boring untimed-get tests:
comment|// Boring timed-get tests:
comment|// Boring getUnchecked tests:
comment|// Edge case tests of the exception-construction code through untimed get():
comment|// Mostly an example of how it would look like to use a list of mixed types
DECL|method|failureWithCause (Throwable cause, String message)
specifier|static
name|AssertionFailedError
name|failureWithCause
parameter_list|(
name|Throwable
name|cause
parameter_list|,
name|String
name|message
parameter_list|)
block|{
name|AssertionFailedError
name|failure
init|=
operator|new
name|AssertionFailedError
argument_list|(
name|message
argument_list|)
decl_stmt|;
name|failure
operator|.
name|initCause
argument_list|(
name|cause
argument_list|)
expr_stmt|;
return|return
name|failure
return|;
block|}
comment|/**    * A future that throws a runtime exception from get.    */
DECL|class|BuggyFuture
specifier|static
class|class
name|BuggyFuture
extends|extends
name|AbstractFuture
argument_list|<
name|String
argument_list|>
block|{
annotation|@
name|Override
DECL|method|get ()
specifier|public
name|String
name|get
parameter_list|()
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|()
throw|;
block|}
annotation|@
name|Override
DECL|method|set (String v)
specifier|public
name|boolean
name|set
parameter_list|(
name|String
name|v
parameter_list|)
block|{
return|return
name|super
operator|.
name|set
argument_list|(
name|v
argument_list|)
return|;
block|}
block|}
comment|// This test covers a bug where an Error thrown from a callback could cause the TimeoutFuture to
comment|// never complete when timing out.  Notably, nothing would get logged since the Error would get
comment|// stuck in the ScheduledFuture inside of TimeoutFuture and nothing ever calls get on it.
comment|// Simulate a timeout that fires before the call the SES.schedule returns but the future is
comment|// already completed.
block|}
end_class

end_unit

